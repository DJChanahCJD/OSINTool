<!DOCTYPE html>
<html lang="zh">
<!-- todo: Ê∑ªÂä†Ëá™ÂÆö‰πâËÑöÊú¨ÈÄâÈ°πÔºàÂç≥‰∏ç‰ΩøÁî®Ëß£ÊûêÂÄºÂõ∫ÂÆöÂÄºÔºåËá™ÂÆö‰πâËÑöÊú¨Ôºâ Ê∑ªÂä†‰∏Ä‰∏™Â≠óÊÆµmodeÔºü -->
<!-- todo: ‰ªªÂä°ÈÖçÁΩÆÊîØÊåÅÊâπÈáèjsonÂØºÂÖ•ÂØºÂá∫-->
<!-- todo: electronËèúÂçïÊ†èËá™ÂÆö‰πâÔºàjsonÂØºÂÖ•ÂØºÂá∫Ôºå XPathÔºåÊ≠£ÂàôËé∑ÂèñÂ∑•ÂÖ∑Ôºâ-->
<!-- todoÔºöËá™Âä®‰øùÂ≠ò‰ªªÂä° -->
<!-- todoÔºöattack_time‰∏∫Êó∂Èó¥Êà≥ long 10‰Ωç -->
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OSINTool</title>
    <style>[v-cloak] { display: none !important;}</style>
    <link rel="preload" href="index.html">
    <link rel="preload" href="edit.html">
    <link rel="stylesheet" href="./styles/edit.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/element-ui@2.15.3/lib/theme-chalk/index.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css">
</head>
<body>
    <div id="app" v-cloak>
        <!-- Ê∑ªÂä†Âä†ËΩΩÊåáÁ§∫Âô® -->
        <div class="page-loading" v-if="!pageReady">
            <i class="el-icon-loading"></i>
        </div>
        <transition name="fade">
            <div v-if="pageReady" class="container">
                <div class="task-header">
                    <el-button icon="el-icon-back" @click="backToList">ËøîÂõûÂàóË°®</el-button>
                    <el-input v-model="currentTask.title" placeholder="‰ªªÂä°ÂêçÁß∞" style="width: 200px;">
                    </el-input>
                    <span style="font-size:12px; color: grey;">id: {{currentTask.id}}</span>
                    <el-button :type="currentTask.isActive ? 'success' : 'danger'"
                        :icon="currentTask.isActive ? 'el-icon-check' : 'el-icon-close'" @click="toggleTaskStatus">
                        {{ currentTask.isActive ? 'ËøêË°å‰∏≠' : 'Â∑≤ÂÅúÊ≠¢' }}
                    </el-button>
                    <el-select v-model="currentTask.id" filterable placeholder="ÈÄâÊã©‰ªªÂä°" @change="loadTask" style="width: 200px;">
                        <el-option v-for="task in tasks" :key="task.id" :label="task.title" :value="task.id">
                            <span style="float: left">{{ task.title }}</span>
                            <span style="float: right; font-weight: bold"
                                :style="{ color: task.isActive ? '#85CE61' : '#F56C6C' }">
                                {{ task.isActive ? 'ËøêË°å‰∏≠' : 'Â∑≤ÂÅúÊ≠¢' }}
                            </span>
                        </el-option>
                    </el-select>
                </div>

                <el-form label-width="80px">
                    <el-form-item label="ÁΩëÂùÄ">
                        <el-input v-model="currentTask.url" placeholder="ËØ∑ËæìÂÖ•ÁΩëÂùÄÊàñÊú¨Âú∞Êñá‰ª∂Ë∑ØÂæÑÔºåÂ¶Ç: http://example.com Êàñ file://path/to/file"></el-input>
                    </el-form-item>
                    <el-form label-width="80px">
                        <el-row :gutter="20">
                            <el-col :span="6">
                                <el-form-item label="Áà¨ÂèñÊ®°Âºè">
                                    <el-select v-model="currentTask.crawlMode" placeholder="ËØ∑ÈÄâÊã©Áà¨ÂèñÊ®°Âºè">
                                        <el-option label="üòÑÊôÆÈÄöÊ®°Âºè" value="general"></el-option>
                                        <el-option label="üëë‰∏ìÂÆ∂Ê®°Âºè" value="pro"></el-option>
                                    </el-select>
                                </el-form-item>
                            </el-col>
                            <el-col :span="12">
                                <el-form-item label="ÂÆöÊó∂Âë®Êúü">
                                    <el-select v-model="currentTask.scheduleType" placeholder="ÊâßË°åÊñπÂºè" style="width: 120px"
                                        @change="handleScheduleTypeChange">
                                        <el-option label="ÂÆöÊó∂" value="fixed"></el-option>
                                        <el-option label="Èó¥Èöî" value="interval"></el-option>
                                        <el-option label="ÈöèÊú∫" value="random"></el-option>
                                    </el-select>
                                    <template v-if="currentTask.scheduleType === 'fixed'">
                                        <span style="margin: 0 5px">ÊØè</span>
                                        <el-input-number v-model="currentTask.days" :min="1" controls-position="right" style="width: 100px">
                                        </el-input-number>
                                        <span style="margin: 0 5px">Â§©</span>
                                        <el-time-picker v-model="currentTask.execTime" format="HH:mm" value-format="HH:mm"
                                            placeholder="ÈÄâÊã©Êó∂Èó¥" style="width: 120px">
                                        </el-time-picker>
                                    </template>
                                    <template v-else-if="currentTask.scheduleType === 'interval'">
                                        <span style="margin: 0 5px">ÊØè</span>
                                        <el-input-number v-model="currentTask.interval" :min="1" controls-position="right"
                                            style="width: 100px">
                                        </el-input-number>
                                        <span style="margin: 0 5px">ÂàÜÈíü</span>
                                    </template>
                                </el-form-item>
                            </el-col>
                        </el-row>
                    </el-form>

                    <template v-if="currentTask.crawlMode === 'pro'">
                        <el-form-item label="Ëß£ÊûêËÑöÊú¨">
                            <el-upload
                                class="upload"
                                action="#"
                                :show-file-list="true"
                                :on-change="handleScriptFileChange"
                                :before-upload="beforeScriptFileUpload"
                                :limit="1"
                            >
                                <template #trigger>
                                    <el-button type="primary" size="medium">
                                        <i class="el-icon-upload2"></i> ‰∏ä‰º†ËÑöÊú¨
                                    </el-button>
                                </template>
                                <span class="script-status" v-if="isScriptExists">
                                    Ê£ÄÊµãÂà∞ËÑöÊú¨Ôºö<a href="#" @click.prevent="openScriptFile">script/{{currentTask.id}}.py</a>
                                </span>
                                <div class="upload-tip">
                                    <i class="el-icon-info"></i> ‰ªÖÊîØÊåÅ .py Êñá‰ª∂ÔºåËØ∑Â∞ÜËß£ÊûêÁªìÊûúÂ≠òÂÇ®Âà∞ data/{{ currentTask.id }} Êñá‰ª∂Â§π
                                </div>
                            </el-upload>
                        </el-form-item>
                    </template>

                    <template v-else>
                        <el-form label-width="80px">
                            <el-row :gutter="20">
                                <el-col :span="12">
                                    <el-form-item label="Cookies">
                                        <el-input v-model="currentTask.cookies" placeholder="ÔºàÂèØÁ©∫ÔºâËØ∑Â§çÂà∂Á≤òË¥¥ÊµèËßàÂô®ÁöÑCookiesÔºåÂ¶Çbid=xxx; xyz=999; ..."></el-input>
                                    </el-form-item>
                                </el-col>
                            </el-row>
                        </el-form>
                        <el-form label-width="80px">
                            <el-row :gutter="20">
                              <el-col :span="6">
                                <el-form-item label="Êï∞ÊçÆÊ†ºÂºè">
                                  <el-select v-model="currentTask.dataFormat" placeholder="ËØ∑ÈÄâÊã©Êï∞ÊçÆÊ†ºÂºè">
                                    <el-option label="ÊñáÊú¨Á±ªÔºàTXTÔºâ" value="txt"></el-option>
                                    <el-option label="Ë°®Ê†ºÁ±ªÔºàCSVÔºâ" value="csv"></el-option>
                                    <el-option label="ÁΩëÈ°µÁ±ªÔºàHTMLÔºâ" value="html"></el-option>
                                  </el-select>
                                </el-form-item>
                              </el-col>
                              <el-col :span="6">
                                <el-form-item label="Ëß£ÊûêÁ±ªÂûã">
                                  <el-select v-model="currentTask.parseType" placeholder="Ë°®Ê†ºËß£ÊûêÁ±ªÂûã">
                                    <el-option label="ÂàóÁ¥¢ÂºïÔºà‰ªé0ÂºÄÂßãÔºâ" :value="0" v-if="currentTask.dataFormat !== 'html'"></el-option>
                                    <el-option label="Ê≠£ÂàôÂåπÈÖç" :value="1"></el-option>
                                  </el-select>
                                </el-form-item>
                              </el-col>
                              <el-col :span="12">
                                <el-form-item label="ÊúÄÂ§ßÁà¨ÂèñÊï∞" label-width="100px">
                                  <el-input-number v-model="currentTask.maxCount" :min="1" controls-position="right" placeholder="‰∏çÂ∞ë‰∫é1" style="margin: 0 4px;"></el-input-number>
                                </el-form-item>
                              </el-col>
                            </el-row>
                          </el-form>
                        <el-form-item label="XPath" v-if="currentTask.dataFormat === 'html'">
                            <el-row :gutter="10">
                                <el-col :span="7">
                                    <el-input v-model="currentTask.xpaths.table" placeholder="Ë°®Ê†ºXPathÔºåÂ¶Ç: //div[@role='table']"></el-input>
                                </el-col>
                                <el-col :span="7">
                                    <el-input v-model="currentTask.xpaths.row" placeholder="Ë°åXPathÔºàÁõ∏ÂØπ‰∫éË°®Ê†ºÔºâ"></el-input>
                                </el-col>
                                <el-col :span="7">
                                    <el-input v-model="currentTask.xpaths.next_page" placeholder="‰∏ã‰∏ÄÈ°µÊåâÈíÆXPath"></el-input>
                                </el-col>
                            </el-row>
                        </el-form-item>
                        <el-form-item label="Ë°®Ê†ºÂåπÈÖç" v-if="currentTask.dataFormat === 'txt'">
                            <el-row :gutter="10">
                                <el-col :span="12">
                                    <el-input v-model="currentTask.table_pattern" placeholder="Ë°®Ê†ºÁöÑÊ≠£ÂàôÂåπÈÖçÔºå‰ªéÊØèË°åÂºÄÂ§¥ÂåπÈÖçÔºåÂ¶Ç: (\S+)\s+#\s+domain - (.*)"></el-input>
                                </el-col>
                            </el-row>
                        </el-form-item>
                        <el-form-item label="ÂàóËß£Êûê">
                            <div v-for="(item, index) in currentTask.parseValues" :key="index" class="dynamic-row">
                                <el-row :gutter="10" type="flex" align="middle">
                                    <el-col :span="8">
                                        <el-input v-model="item.key" placeholder="Ëß£ÊûêÂ≠óÊÆµ"></el-input>
                                    </el-col>
                                    <el-col :span="8">
                                        <template v-if ="currentTask.parseType === 0">
                                            <span>Á¨¨</span>
                                            <el-input-number v-model="item.index" :min="0" controls-position="right" placeholder="ÂàóÁ¥¢Âºï"></el-input-number>
                                            <span>Âàó</span>
                                        </template>
                                        <el-input v-else v-model="item.pattern" placeholder="Ê≠£ÂàôË°®ËææÂºèÔºåÂ¶ÇÔºö(ÁÆÄÂçï|‰∏≠Á≠â|Âõ∞Èöæ)"></el-input>
                                    </el-col>
                                    <el-col :span="2">
                                        <el-button type="danger" icon="el-icon-delete" @click="removeParseValue(index)"></el-button>
                                    </el-col>
                                </el-row>
                            </div>
                            <el-button type="primary" icon="el-icon-plus" @click="addParseValue">Ê∑ªÂä†Ëß£ÊûêÂÄº</el-button>
                        </el-form-item>
                        <el-form-item label="ÂÖ∂‰ªñÂÄº">
                            <div v-for="(item, index) in currentTask.otherValues" :key="index" class="dynamic-row">
                                <el-row :gutter="10" type="flex" align="middle">
                                    <el-col :span="7">
                                        <el-input v-model="item.source" placeholder="ËØ∑ËæìÂÖ•Ê∫êÂÄº"></el-input>
                                    </el-col>
                                    <el-col :span="4">
                                        <el-select v-model="item.valueType" placeholder="ÂèñÂÄºÁ±ªÂûã">
                                            <el-option label="Âõ∫ÂÆöÂÄº" value="fixed"></el-option>
                                            <el-option label="Ê≠£ÂàôÂåπÈÖç" value="regex"></el-option>
                                            <el-option label="ÁâπÊÆäÂÄº" value="special"></el-option>
                                        </el-select>
                                    </el-col>
                                    <el-col :span="11">
                                        <el-input v-if="item.valueType != 'special'" v-model="item.target" placeholder="ËØ∑ËæìÂÖ•Âõ∫ÂÆöÂÄºÊàñÊ≠£ÂàôË°®ËææÂºè"></el-input>
                                        <el-select v-else v-model="item.target" placeholder="ËØ∑ÈÄâÊã©ÁâπÊÆäÂÄº">
                                            <el-option
                                                v-for="option in specialValues"
                                                :key="option.value"
                                                :label="option.label"
                                                :value="option.value"
                                            ></el-option>
                                        </el-select>
                                    </el-col>
                                    <el-col :span="2">
                                        <el-button type="danger" icon="el-icon-delete" @click="removeOtherValues(index)"></el-button>
                                    </el-col>
                                </el-row>
                            </div>
                            <el-button type="primary" icon="el-icon-plus" @click="addOtherValues" style="margin-bottom: 40px;">Ê∑ªÂä†ÂÖ∂‰ªñÂÄº</el-button>
                        </el-form-item>
                    </template>
                </el-form>
                <div class="action-buttons">
                    <el-button type="warning" icon="el-icon-refresh" @click="runTask">ËøêË°å</el-button>
                    <el-button type="info" icon="el-icon-search" @click="showPreview">È¢ÑËßà</el-button>
                    <div style="float: right">
                        <el-button icon="el-icon-plus" type="primary" @click="createNewTask">Êñ∞Â¢û</el-button>
                        <el-button icon="el-icon-copy-document" type="primary" @click="copyToNewTask">Â§çÂà∂</el-button>
                        <el-button icon="el-icon-files" type="success" @click="saveTask">‰øùÂ≠ò</el-button>
                        <el-button icon="el-icon-delete" type="danger" @click="deleteTask">Âà†Èô§</el-button>
                        <el-button icon="el-icon-folder-opened" type="info" @click="getResult">Êü•ÁúãËß£ÊûêÁªìÊûú</el-button>
                    </div>
                </div>

                <!-- Ë°®Ê†ºÈ¢ÑËßàËß£ÊûêÁªìÊûúÂØπËØùÊ°Ü -->
                <el-dialog :visible.sync="dialogVisible" title="Ëß£ÊûêÁªìÊûú" width="80%" append-to-body>
                    <el-table :data="parsedTable" style="width: 100%; max-height: 400px; overflow: auto;">
                        <el-table-column type="index" label="Ë°åÂè∑" :index="customRowIndex" width="60">
                            <template slot-scope="scope">
                                <span style="font-weight: bold; color: #909399">Ë°å{{ scope.$index + 1 }}</span>
                            </template>
                        </el-table-column>
                        <el-table-column
                            v-for="(col, index) in tableColumns"
                            :key="index"
                            :label="col.label"
                            :prop="col.prop"
                            :width="100"
                        ></el-table-column>
                    </el-table>

                </el-dialog>
            </div>
        </transition>
    </div>
</body>
<script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.js"></script>
<script src="https://cdn.jsdelivr.net/npm/element-ui@2.15.3/lib/index.js"></script>
<script src="https://cdn.jsdelivr.net/npm/lodash@4.17.21/lodash.min.js"></script>
<script>
    new Vue({
        el: '#app',
        data: {
            pageReady: false,
            tasks: [],
            currentTask: {
                id: null,
                title: '',
                url: '',
                scheduleType: 'random', // 'fixed' Êàñ 'random' Êàñ 'interval'
                days: 1,
                execTime: '',
                schedule: '', // ÊúÄÁªàÂ≠òÂÇ®ÁöÑcronË°®ËææÂºè
                dataFormat: 'txt',
                parseType: 1, // 0: ÂàóËß£Êûê, 1:Ê≠£ÂàôÂåπÈÖç
                table_pattern: '',
                interval: 1, // Èó¥ÈöîÊó∂Èó¥ÔºàÂàÜÈíüÔºâ
                xpaths: {
                    table: '',  // Ë°®Ê†ºXPath
                    row: '',    // Ë°åXPath
                    next_page: '' // ‰∏ã‰∏ÄÈ°µÊåâÈíÆXPath
                },
                parseValues: [],
                otherValues: [],
                isActive: false,
                maxCount: 10,    // ÊúÄÂ§öÁà¨ÂèñÊï∞ÊçÆÊï∞Èáè,
                crawlMode: 'general',
                cookies: '',
            },
            specialValues: [
                { value: 'attack_time', label: 'Áà¨ÂèñÊó∂Èó¥' },
                { value: 'attack_timestamp', label: 'Áà¨ÂèñÊó∂Èó¥Ôºà10‰ΩçlongÊó∂Èó¥Êà≥Ôºâ' },

            ],
            dialogVisible: false,
            parsedTable: [],
            tableColumns: [],
            originalTask: {},
            isScriptExists: false,
        },
        watch: {
            'currentTask.dataFormat': {
                immediate: true,
                handler() {
                    if (this.currentTask.dataFormat === 'html') {
                        this.currentTask.parseType = 1; // html Ê®°Âºè‰∏ãÂè™ÂÖÅËÆ∏‰ΩøÁî®Ê≠£ÂàôÂåπÈÖçË°åÂàó
                    }
                }
            }
        },
        methods: {
            async checkScriptFile() {
                if (!this.currentTask.id) return;
                try {
                    const exists = await window.api.checkScriptExists(this.currentTask.id);
                    this.isScriptExists = exists;
                } catch (error) {
                    console.error('Error checking script existence:', error);
                }
            },
            openScriptFile() {
                window.api.openScriptFile(this.currentTask.id);
            },
            // Âà§Êñ≠ÂΩìÂâç‰ªªÂä°Êï∞ÊçÆÊòØÂê¶Â∑≤Ë¢´‰øÆÊîπ
            isTaskChanged() {
                return JSON.stringify(this.currentTask) !== JSON.stringify(this.originalTask);
            },
            backToList() {
                window.location.href = 'index.html';
            },
            beforeScriptFileUpload(file) {
                if (this.currentTask.id == null) {
                    this.$message.warning('ËØ∑ÂÖàÈÄâÊã©‰ªªÂä°');
                    return false;
                }
                if (this.currentTask.crawlMode !== 'pro') {
                    this.$message.warning('Èùû‰∏ìÂÆ∂Ê®°ÂºèÊó†Ê≥ï‰∏ä‰º†ËÑöÊú¨');
                    return false;
                }
                // Ê£ÄÊü•Êñá‰ª∂Á±ªÂûã
                const allowedTypes = ['py'];
                const fileExtension = file.name.split('.').pop().toLowerCase();
                if (!allowedTypes.includes(fileExtension)) {
                    this.$message.error('ËØ∑‰∏ä‰º†.pyÊñá‰ª∂');
                    return false;
                }
                return true;
            },
            handleScriptFileChange: _.debounce(async function(file) {
                if (!file) return;
                if (this.currentTask.id == null) {
                    this.$message.warning('ËØ∑ÂÖà‰øùÂ≠ò‰ªªÂä°');
                    return;
                }
                try {
                    const isOk = await window.api.uploadScript(this.currentTask.id, file);
                    if (isOk) {
                        this.isFileUploaded = true;
                        this.$message.success('ËÑöÊú¨‰∏ä‰º†ÊàêÂäü');
                        await this.checkScriptFile();
                    } else {
                        this.$message.error('ËÑöÊú¨‰∏ä‰º†Â§±Ë¥•');
                    }
                } catch (error) {
                    this.$message.error('‰∏ä‰º†ËøáÁ®ã‰∏≠ÂèëÁîüÈîôËØØÔºö' + error.message);
                }
            }, 300),    // 300ÊØ´ÁßíÂÜÖÂè™ÊâßË°å‰∏ÄÊ¨°ÔºåÈò≤Ê≠¢Â§öÊ¨°‰∏ä‰º†
            async loadTasks() {
                try {
                    this.tasks = await window.api.getTasks();
                    if (this.tasks.length > 0 && this.currentTask.id) {
                        await this.loadTask(this.currentTask.id);
                    } else {
                        this.createNewTask();
                    }
                } catch (error) {
                    this.$message.error('Âä†ËΩΩ‰ªªÂä°Â§±Ë¥•');
                    this.createNewTask();
                }
            },
            async loadTask(taskId) {
                try {
                    const task = await window.api.getTask(taskId);
                    if (task) {
                        this.currentTask = task;
                        this.originalTask = JSON.parse(JSON.stringify(task));
                        localStorage.setItem('currentTaskId', JSON.stringify(taskId));
                        await this.checkScriptFile();
                    }
                } catch (error) {
                    this.$message.error('Âä†ËΩΩÂ§±Ë¥•');
                    localStorage.removeItem('currentTaskId');
                }
            },
            async runTask() {
                // Âà§Êñ≠Êï∞ÊçÆÊòØÂê¶ÊúâÊîπÂä®
                if (this.isTaskChanged()) {
                    try {
                        await this.$confirm('Ê£ÄÊµãÂà∞Êï∞ÊçÆÂ∑≤ÊîπÂèòÔºåÊòØÂê¶‰øùÂ≠ò‰ªªÂä°Ôºü', 'ÊèêÁ§∫', {
                            confirmButtonText: '‰øùÂ≠ò',
                            cancelButtonText: 'ÂèñÊ∂à',
                            type: 'warning'
                        });
                        await this.saveTask();
                    } catch (error) {
                        // Áî®Êà∑ÂèñÊ∂à‰∫Ü‰øùÂ≠òÔºåÂàô‰∏çÁªßÁª≠ËøêË°å‰ªªÂä°
                        return;
                    }
                }
                const loadingMessage = this.$message({
                    message: `Ê≠£Âú®ËøêË°å‰ªªÂä° ${this.currentTask.title} ...`,
                    type: 'info',
                    duration: 0,
                    showClose: true
                });
                try {
                    const response = await window.api.runTask(this.currentTask.id);
                    if (response.success) {
                        this.$message.success('ËøêË°åÊàêÂäü');
                    }
                } catch (error) {
                    this.$message.error('ËøêË°åÂ§±Ë¥•Ôºö' + error);
                } finally {
                    loadingMessage.close();
                }
            },
            createNewTask() {
                this.currentTask = {
                    id: null,
                    title: `Êñ∞‰ªªÂä°${this.tasks.length + 1}`,
                    url: '',
                    scheduleType: 'random',
                    days: 1,
                    execTime: '',
                    schedule: '',
                    dataFormat: 'txt', // ËÆæÁΩÆÈªòËÆ§Ê†ºÂºè
                    parseType: 1, // 0: ÂàóÁ¥¢ÂºïÔºå1: Ê≠£ÂàôÂåπÈÖç
                    table_pattern: '',
                    xpaths: {
                        table: '',  // Ë°®Ê†ºXPath
                        row: '',    // Ë°åXPath
                        next_page: '' // ‰∏ã‰∏ÄÈ°µÊåâÈíÆXPath
                    },
                    interval: 1, // Èó¥ÈöîÊó∂Èó¥ÔºàÂàÜÈíüÔºâ
                    parseValues: [],
                    otherValues: [],
                    isActive: false,
                    maxCount: 10,    // ÊúÄÂ§öÁà¨ÂèñÊï∞ÊçÆÊï∞Èáè
                    crawlMode: 'general',
                    cookies: '',
                };
                this.originalTask = JSON.parse(JSON.stringify(this.currentTask));
            },
            async copyToNewTask () {
                try {
                    const newTask = JSON.parse(JSON.stringify(this.currentTask));
                    this.createNewTask();
                    this.currentTask = newTask;
                    newTask.id = null;
                    newTask.title = `${this.currentTask.title}(ÂâØÊú¨)`;
                    await this.saveTask();
                }
                catch (error) {
                    this.$message.error('Â§çÂà∂Â§±Ë¥•: ' + error.message);
                }
            },
            async showPreview() {
                if (!this.currentTask.id) {
                    this.$message.warning('ËØ∑ÂÖàÈÄâÊã©‰ªªÂä°');
                    return;
                }

                const loadingMessage = this.$message({
                    message: `Ê≠£Âú®Ëß£Êûê‰ªªÂä° ${this.currentTask.title} ...`,
                    type: 'info',
                    duration: 0,
                    showClose: true
                });

                try {
                    const response = await window.api.parseTask(this.currentTask.id);
                    if (response.success) {
                        this.parsedTable = response.table;
                        // ÊâìÂç∞Ââç5Ë°åÔºåÊ£ÄÊü•Êï∞ÊçÆÊ†ºÂºè
                        console.log(this.parsedTable.slice(0, 5));

                        // Á°Æ‰øùËé∑ÂèñÁ¨¨‰∏Ä‰∏™Êï∞ÊçÆË°åÁöÑÂ≠óÊÆµÂêç‰Ωú‰∏∫ÂàóÊ†áÈ¢ò
                        const firstRow = this.parsedTable[0];
                        if (firstRow) {
                            this.tableColumns = Object.keys(firstRow).map(key => ({
                                label: key,  // ‰ΩøÁî®Â≠óÊÆµÂêç‰Ωú‰∏∫ÂàóÊ†áÈ¢ò
                                prop: key    // ‰ΩøÁî®Â≠óÊÆµÂêç‰Ωú‰∏∫ÂàóÁöÑprop
                            }));
                        }

                        this.dialogVisible = true;
                    } else {
                        this.$message.error('Ëß£ÊûêÂ§±Ë¥•: ' + response.error);
                    }
                } catch (error) {
                    this.$message.error('Ëß£ÊûêÂ§±Ë¥•: ' + error.message);
                } finally {
                    loadingMessage.close();
                }
            },
            async getResult() {
                if (!this.currentTask.id) {
                    this.$message.warning('ËØ∑ÂÖàÈÄâÊã©‰ªªÂä°');
                    return;
                }

                try {
                    // Áõ¥Êé•ÊâìÂºÄÁîµËÑë‰ªªÂä°ÁÆ°ÁêÜÂô®ÁöÑÊñá‰ª∂Â§π
                    await window.api.openTaskResultFolder(this.currentTask.id);
                } catch (error) {
                    if (error !== 'cancel') {
                        this.$message.error('Êó†Ê≥ïÊâìÂºÄÊñá‰ª∂Â§π:'+ error.message);
                    }
                }
            },
            async saveTask() {
                try {
                    if (!this.validateData()) {
                        return;
                    }
                    this.updateSchedule();

                    if (this.currentTask.id) {
                        await window.api.updateTask(this.currentTask.id, this.currentTask);
                    } else {
                        const result = await window.api.createTask(this.currentTask);
                        this.currentTask.id = result.id;
                    }
                    await this.loadTasks();
                    this.$message.success('‰øùÂ≠òÊàêÂäü');
                } catch (error) {
                    this.$message.error('‰øùÂ≠òÂ§±Ë¥•: ' + error.message);
                }
            },
            async deleteTask() {
                if (!this.currentTask.id) {
                    this.$message.warning('ËØ∑ÂÖàÈÄâÊã©Ë¶ÅÂà†Èô§ÁöÑ‰ªªÂä°');
                    return;
                }

                try {
                    await this.$confirm('Á°ÆËÆ§Âà†Èô§ËØ•‰ªªÂä°ÂêóÔºü', 'ÊèêÁ§∫', {
                        confirmButtonText: 'Á°ÆÂÆö',
                        cancelButtonText: 'ÂèñÊ∂à',
                        type: 'warning'
                    });

                    const currentIndex = this.tasks.findIndex(task => task.id === this.currentTask.id);
                    await window.api.deleteTask(this.currentTask.id);
                    this.$message.success('Âà†Èô§ÊàêÂäü');
                    if (currentIndex >= 0) {
                        // Â¶ÇÊûúÂà†Èô§ÁöÑÊòØÊúÄÂêé‰∏Ä‰∏™‰ªªÂä°ÔºåÈÄâÊã©Ââç‰∏Ä‰∏™‰ªªÂä°
                        if (currentIndex === this.tasks.length - 1) {
                            this.currentTask = this.tasks[currentIndex - 1] || null;
                        } else {
                            // Âê¶ÂàôÈÄâÊã©Âà†Èô§ÂêéÁöÑ‰∏ã‰∏Ä‰∏™‰ªªÂä°
                            this.currentTask = this.tasks[currentIndex + 1] || null;
                        }
                    }
                    await this.loadTasks();

                } catch (error) {
                    if (error !== 'cancel') {
                        this.$message.error('Âà†Èô§Â§±Ë¥•: ' + error.message);
                    }
                }
            },
            validateData() {
                // ÂÆö‰πâÈîôËØØÊèêÁ§∫ÂáΩÊï∞ÔºåÂáèÂ∞ëÈáçÂ§ç‰ª£Á†Å
                const showWarning = (message) => {
                    this.$message.warning(message);
                    return false;
                };

                // Âü∫Êú¨È™åËØÅ
                if (!this.currentTask.title.trim()) {
                    return showWarning('ËØ∑ËæìÂÖ•‰ªªÂä°ÂêçÁß∞');
                }

                const isValidUrl = /^https?:\/\/.+/i.test(this.currentTask.url) || /file:\/\/.+/i.test(this.currentTask.url);
                if (!this.currentTask.url.trim() ||!isValidUrl) {
                    return showWarning('ËØ∑ËæìÂÖ•ÂêàÊ≥ïÁõÆÊ†áURL, Â¶Ç: http://example.com Êàñ file:///path/to/file');
                }

                if (!this.currentTask.dataFormat) {
                    return showWarning('ËØ∑ÈÄâÊã©Êï∞ÊçÆÊ†ºÂºè');
                }

                if (this.currentTask.dataFormat!== 'html' && this.table_pattern &&!this.table_pattern.trim()) {
                    try {
                        new RegExp(this.table_pattern);
                    } catch (error) {
                        return showWarning('Ë°®Ê†ºÊ≠£ÂàôÂåπÈÖç‰∏çÂêàÊ≥ïÔºåËØ∑ÂÖàÂú®https://regex101.com/ È™åËØÅÊòØÂê¶ÂåπÈÖç');
                    }
                }

                if (this.currentTask.scheduleType === 'fixed' && (!this.currentTask.days ||!this.currentTask.execTime)) {
                    return showWarning('ËØ∑Â°´ÂÜôÂÆöÊó∂‰ªªÂä°ÁöÑÂ§©Êï∞ÂíåÊâßË°åÊó∂Èó¥');
                }

                if (this.currentTask.scheduleType === 'interval' &&!this.currentTask.interval) {
                    return showWarning('ËØ∑Â°´ÂÜôÈó¥ÈöîÊó∂Èó¥');
                }

                // xpathÈ™åËØÅ
                if (this.currentTask.dataFormat === 'html') {
                    const xpathRegex = /^(\/\/?|@|[\w-]+|\[.*?\]|\(.*?\)|\*|@[\w-]+|\.\.|\.)/;

                    const validateXPath = (xpath, message) => {
                        if (!xpath.trim() ||!xpathRegex.test(xpath)) {
                            return showWarning(message);
                        }
                        return true;
                    };

                    if (!validateXPath(this.currentTask.xpaths.table, 'ËØ∑ËæìÂÖ•ÂêàÊ≥ïË°®Ê†ºXPath')) return false;
                    if (!validateXPath(this.currentTask.xpaths.row, 'ËØ∑ËæìÂÖ•ÂêàÊ≥ïË°åXPath')) return false;
                    if (this.currentTask.xpaths.next_page &&!validateXPath(this.currentTask.xpaths.next_page, 'ËØ∑ËæìÂÖ•ÂêàÊ≥ï‰∏ã‰∏ÄÈ°µÊåâÈíÆXPath')) return false;

                    // ÂéªÊéâÂ§ö‰ΩôÁ©∫Ê†º
                    this.currentTask.xpaths.table = this.currentTask.xpaths.table.trim();
                    this.currentTask.xpaths.row = this.currentTask.xpaths.row.trim();
                    this.currentTask.xpaths.next_page = this.currentTask.xpaths.next_page.trim();
                }

                // Ëß£ÊûêÂÄºÈ™åËØÅ
                if (!this.currentTask.parseValues || this.currentTask.parseValues.length === 0) {
                    return showWarning('ËØ∑Ê∑ªÂä†Ëß£ÊûêÂÄº');
                }

                if (this.currentTask.parseValues.some(item =>!item.key.trim())) {
                    return showWarning('Ëß£ÊûêÂ≠óÊÆµ‰∏çËÉΩ‰∏∫Á©∫');
                }

                // ÂÖ∂‰ªñÂÄºÈ™åËØÅ
                if (this.currentTask.otherValues.some(item =>!item.source.trim() ||!item.target.trim())) {
                    return showWarning('Ê∫êÂÄºÂíåÁõÆÊ†áÂÄº‰∏çËÉΩ‰∏∫Á©∫');
                }

                // Ê≠£ÂàôË°®ËææÂºèÈ™åËØÅ
                if (this.currentTask.parseType === 1) {
                    for (let item of this.currentTask.parseValues) {
                        try {
                            new RegExp(item.pattern);
                        } catch (error) {
                            return showWarning(`${item.key}ÁöÑÊ≠£ÂàôË°®ËææÂºè‰∏çÂêàÊ≥ïÔºåËØ∑ÂÖàÂú®https://regex101.com/ È™åËØÅÊòØÂê¶ÂåπÈÖç`);
                        }
                    }
                }

                // ÊúÄÂ§ßÁà¨ÂèñÊï∞ÈáèÈ™åËØÅ
                if (!this.currentTask.maxCount) {
                    return showWarning('ËØ∑Â°´ÂÜôÊúÄÂ§öÁà¨ÂèñÊï∞ÊçÆÊï∞Èáè');
                }

                // cookies Ê†ºÂºèÈ™åËØÅ
                if (this.currentTask.cookies) {
                    const cookiesRegex = /^([^=;]+=[^;]*;?\s*)+$/;
                    if (!cookiesRegex.test(this.currentTask.cookies)) {
                        return showWarning('ËØ∑ËæìÂÖ•ÂêàÊ≥ïÁöÑCookiesÊ†ºÂºèÔºåÂ¶Çbid=xxx; xyz=999; ...');
                    }
                }

                return true;
            },
            addParseValue() {
                this.currentTask.parseValues.push({
                    key: '',        // Â≠óÊÆµÂêç
                    index: 0,        // ÂàóÁ¥¢Âºï
                    pattern: '',      // Ê≠£ÂàôÂåπÈÖçË°®ËææÂºè
                });
            },
            removeParseValue(index) {
                this.currentTask.parseValues.splice(index, 1);
            },
            addOtherValues() {
                this.currentTask.otherValues.push({
                    source: '',
                    valueType: 'fixed',
                    target: ''
                });
            },
            removeOtherValues(index) {
                this.currentTask.otherValues.splice(index, 1);
            },
            async toggleTaskStatus() {
                try {
                    this.currentTask.isActive = !this.currentTask.isActive;
                    await window.api.updateTaskStatus(
                        this.currentTask.id,
                        this.currentTask.isActive
                    );
                    await this.loadTasks();
                    this.$message.success('Êõ¥Êñ∞Áä∂ÊÄÅÊàêÂäü');
                } catch (error) {
                    this.$message.error('Êõ¥Êñ∞Áä∂ÊÄÅÂ§±Ë¥•ÔºåËØ∑Ê£ÄÊü•ÁΩëÁªúËøûÊé•');
                    this.currentTask.isActive = !this.currentTask.isActive; // ÊÅ¢Â§çÁä∂ÊÄÅ
                }
            },
            handleScheduleTypeChange(value) {
                // ÂàáÊç¢Âà∞ÈöèÊú∫
                if (value === 'random') {
                    this.currentTask.days = 1;
                    this.currentTask.execTime = '';
                    this.currentTask.schedule = '';
                }
                // ÂàáÊç¢Âà∞ÂÆöÊó∂
                else if (value === 'fixed') {
                    // Â¶ÇÊûú‰πãÂâçÊ≤°ÊúâËÆæÁΩÆËøáÊó∂Èó¥ÔºåËÆæÁΩÆÈªòËÆ§ÂÄº
                    if (!this.currentTask.execTime) {
                        this.currentTask.execTime = '00:00';
                    }
                    this.updateSchedule();
                }
                // Èó¥ÈöîÂ§öÂ∞ëÊó∂Èó¥
                else if (value === 'interval') {
                    console.log('interval:', this.currentTask.interval);
                }
            },
            // Êõ¥Êñ∞cronË°®ËææÂºè
            updateSchedule() {
                if (this.currentTask.scheduleType === 'fixed' && this.currentTask.execTime) {
                    const [hours, minutes] = this.currentTask.execTime.split(':');
                    this.currentTask.schedule = `${minutes} ${hours} */${this.currentTask.days} * *`;
                } else {
                    this.currentTask.schedule = '';
                }
            },
            // Ëá™ÂÆö‰πâÈ¢ÑËßàË°åÂè∑
            customRowIndex(index) {
                return index;
            },
            async initializeTask() {
                const storedTaskId = localStorage.getItem('currentTaskId');
                if (storedTaskId) {
                    // ÁºñËæëÂ∑≤Êúâ‰ªªÂä°
                    this.currentTask.id = JSON.parse(storedTaskId);
                } else {
                    // ÂàõÂª∫Êñ∞‰ªªÂä°
                    this.createNewTask();
                }
            },
        },
        async mounted() {
            try {
                await this.initializeTask();
                await this.loadTasks();
                // ‰ΩøÁî® nextTick Á°Æ‰øù DOM Êõ¥Êñ∞
                this.$nextTick(() => {
                    this.pageReady = true;
                });
            } catch (error) {
                console.error('Page initialization failed:', error);
                this.$message.error('È°µÈù¢Âä†ËΩΩÂ§±Ë¥•');
            }
        }
    });
</script>
</html>