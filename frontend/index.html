<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OSINTool</title>
    <link rel="stylesheet" href="./styles.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/element-ui@2.15.3/lib/theme-chalk/index.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css">
</head>
<body>
    <div id="app" class="container">
        <div class="task-header">
            <el-input
                v-model="currentTask.title"
                placeholder="任务名称"
                style="width: 200px;"
                clearable>
            </el-input>
            <span style="font-size:12px; color: grey;">id: {{currentTask.id}}</span>
            <el-button
                :type="currentTask.isActive ? 'success' : 'danger'"
                :icon="currentTask.isActive ? 'el-icon-check' : 'el-icon-close'"
                @click="toggleTaskStatus"
                >
                {{ currentTask.isActive ? '运行中' : '已停止' }}
            </el-button>
            <el-select
                v-model="currentTaskId"
                filterable
                placeholder="选择任务"
                @change="loadTask"
                style="width: 200px;"
                clearable>
                <el-option
                    v-for="task in tasks"
                    :key="task.id"
                    :label="task.title"
                    :value="task.id">
                    <span style="float: left">{{ task.title }}</span>
                    <span style="float: right; font-weight: bold" :style="{ color: task.isActive ? '#85CE61' : '#F56C6C' }">
                        {{ task.isActive ? '运行中' : '已停止' }}
                    </span>
                </el-option>
            </el-select>
        </div>

        <el-form label-width="80px">
            <el-form-item label="网址">
                    <el-input v-model="currentTask.url" placeholder="请输入网址"></el-input>
                </el-form-item>
            </el-col>
            <el-form-item label="定时周期">
                <el-select
                    v-model="currentTask.scheduleType"
                    placeholder="执行方式"
                    style="width: 120px"
                    @change="handleScheduleTypeChange">
                    <el-option label="定时" value="fixed"></el-option>
                    <el-option label="不定时" value="manual"></el-option>
                </el-select>
                <template v-if="currentTask.scheduleType === 'fixed'">
                    <span style="margin: 0 5px">每</span>
                    <el-input-number
                        v-model="currentTask.days"
                        :min="1"
                        controls-position="right"
                        style="width: 100px">
                    </el-input-number>
                    <span style="margin: 0 5px">天</span>
                    <el-time-picker
                        v-model="currentTask.execTime"
                        format="HH:mm"
                        value-format="HH:mm"
                        placeholder="选择时间"
                        style="width: 120px">
                    </el-time-picker>
                </template>
            </el-form-item>

            <el-form-item label="数据格式">
                <el-row :gutter="10">
                    <el-col :span="8">
                        <el-select v-model="currentTask.dataFormat" placeholder="请选择数据格式">
                            <el-option label="TXT" value="txt"></el-option>
                            <el-option label="HTML" value="html"></el-option>
                            <el-option label="PHP" value="php"></el-option>
                            <el-option label="CSV" value="html"></el-option>
                        </el-select>
                    </el-col>
                    <el-col :span="4">
                        <!-- 是否忽略注释解析 -->
                        <el-checkbox v-model="currentTask.ignoreComment">忽略注释</el-checkbox>
                    </el-col>
                </el-row>
            </el-form-item>

            <el-form-item label="解析值">
                <div v-for="(item, index) in currentTask.parseValues" :key="index" class="dynamic-row">
                  <el-row :gutter="10" type="flex" align="middle">
                    <el-col :span="8">
                      <el-input v-model="item.key" placeholder="解析字段"></el-input>
                    </el-col>
                    <el-col :span="4">
                      <el-select v-model="item.parseType" placeholder="解析类型">
                        <el-option label="列号" value="column"></el-option>
                        <el-option label="注释" value="comment"></el-option>
                      </el-select>
                    </el-col>
                    <el-col :span="8">
                      <el-input-number
                        v-if="item.parseType === 'column'"
                        v-model="item.column"
                        :min="1"
                        placeholder="列号">
                      </el-input-number>
                      <el-input
                        v-else
                        v-model="item.value"
                        :placeholder="getParseValuePlaceholder(item.parseType)">
                        </el-input>
                    </el-col>
                    <el-col :span="2">
                      <el-button type="danger" icon="el-icon-delete" @click="removeParseValue(index)"></el-button>
                    </el-col>
                  </el-row>
                </div>
                <el-button type="primary" icon="el-icon-plus" @click="addParseValue">添加解析值</el-button>
              </el-form-item>

            <el-form-item label="固定值">
                <div v-for="(item, index) in currentTask.fixedValues" :key="index" class="dynamic-row">
                    <el-row :gutter="10" type="flex" align="middle">
                        <el-col :span="8">
                            <el-input v-model="item.source" placeholder="请输入源值"></el-input>
                        </el-col>
                        <el-col :span="12">
                            <el-input v-model="item.target" placeholder="请输入目标值"></el-input>
                        </el-col>
                        <el-col :span="2">
                            <el-button type="danger" icon="el-icon-delete" @click="removeFixedValue(index)"></el-button>
                        </el-col>
                    </el-row>
                </div>
                <el-button type="primary" icon="el-icon-plus" @click="addFixedValue">添加固定值</el-button>
            </el-form-item>
        </el-form>
        <!-- todo：添加一个输出列表按钮，点击显示当前任务的解析csv结果 -->
        <div class="action-buttons">
            <el-button type="primary" @click="createNewTask">新增</el-button>
            <el-button type="success" @click="saveTask">保存</el-button>
            <el-button type="warning" @click="editTask">编辑</el-button>
            <el-button type="danger" @click="deleteTask">删除</el-button>
            <el-button type="info" @click="getResult">查看解析结果</el-button>
        </div>
    </div>
</body>
<script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.js"></script>
<script src="https://cdn.jsdelivr.net/npm/element-ui@2.15.3/lib/index.js"></script>
<script>
  new Vue({
      el: '#app',
      data: {
          tasks: [],
          currentTaskId: null,
          currentTask: {
              id: null,
              title: '',
              url: '',
              scheduleType: 'manual', // 'fixed' 或 'manual'
              days: 1,
              execTime: '',
              schedule: '', // 最终存储的cron表达式
              dataFormat: '',
              ignoreComment: false, // 是否忽略注释解析
              parseValues: [],
              fixedValues: [],
              isActive: false
          }
      },
      methods: {
          loadTasks() {
              const savedTasks = localStorage.getItem('tasks');
              if (savedTasks) {
                  this.tasks = JSON.parse(savedTasks);
                  if (this.tasks.length > 0) {
                      this.currentTaskId = this.tasks[0].id;
                      this.loadTask(this.currentTaskId);
                  }
              }
          },
          loadTask(taskId) {
              const task = this.tasks.find(t => t.id === taskId);
              if (task) {
                  this.currentTask = JSON.parse(JSON.stringify(task));
              }
          },
          createNewTask() {
              const newTask = {
                  id: Date.now(),
                  title: `新任务${this.tasks.length + 1}`,
                  url: '',
                  scheduleType: 'manual',
                  days: 1,
                  execTime: '',
                  schedule: '',
                  parseValues: [],
                  fixedValues: [],
                  isActive: false
              };
              this.tasks.push(newTask);
              this.currentTaskId = newTask.id;
              this.loadTask(newTask.id);
          },
          saveTask() {
              this.updateSchedule();
              const index = this.tasks.findIndex(t => t.id === this.currentTask.id);
              if (index !== -1) {
                  this.$set(this.tasks, index, JSON.parse(JSON.stringify(this.currentTask)));
                  localStorage.setItem('tasks', JSON.stringify(this.tasks));
                  this.$message.success('保存成功');
              }
          },
          deleteTask() {
              this.$confirm('确认删除该任务吗？', '提示', {
                  confirmButtonText: '确定',
                  cancelButtonText: '取消',
                  type: 'warning'
              }).then(() => {
                  this.tasks = this.tasks.filter(t => t.id !== this.currentTask.id);
                  localStorage.setItem('tasks', JSON.stringify(this.tasks));
                  if (this.tasks.length > 0) {
                      this.currentTaskId = this.tasks[0].id;
                      this.loadTask(this.currentTaskId);
                  } else {
                      this.currentTask = {
                          id: null,
                          title: '',
                          url: '',
                          scheduleType: 'manual',
                          days: 1,
                          execTime: '',
                          schedule: '',
                          parseValues: [],
                          fixedValues: [],
                          isActive: false
                      };
                  }
                  this.$message.success('删除成功');
              }).catch(() => {});
          },
          addParseValue() {
              this.currentTask.parseValues.push({
                key: '',
                value: '',
                column: 1,
                parseType: 'column'
              });
          },
          removeParseValue(index) {
              this.currentTask.parseValues.splice(index, 1);
          },
          addFixedValue() {
              this.currentTask.fixedValues.push({ source: '', target: '' });
          },
          removeFixedValue(index) {
              this.currentTask.fixedValues.splice(index, 1);
          },
          toggleTaskStatus() {
              this.currentTask.isActive = !this.currentTask.isActive;
              this.saveTask();
          },
          getParseValuePlaceholder(parseType) {
            switch(parseType) {
              case 'column':
                return '列号';
              case 'comment':
                return '注释关键字';
              case 'regex':
                return '正则表达式';
              default:
                return '请输入解析值';
            }
          },
          getResult() {
            this.$confirm('确认查看解析结果?', '提示', {
              confirmButtonText: '确定',
              cancelButtonText: '取消',
              type: 'info'
            }).then(() => {
              this.$message.success('预览成功');
            }).catch(() => {});
          },
          handleScheduleTypeChange(value) {
              // 切换到不定时
              if (value === 'manual') {
                  this.currentTask.days = 1;
                  this.currentTask.execTime = '';
                  this.currentTask.schedule = '';
              }
              // 切换到定时
              else {
                  // 如果之前没有设置过时间，设置默认值
                  if (!this.currentTask.execTime) {
                      this.currentTask.execTime = '00:00';
                  }
                  this.updateSchedule();
              }
          },
          // 更新cron表达式
          updateSchedule() {
              if (this.currentTask.scheduleType === 'fixed' && this.currentTask.execTime) {
                  const [hours, minutes] = this.currentTask.execTime.split(':');
                  this.currentTask.schedule = `${minutes} ${hours} */${this.currentTask.days} * *`;
              } else {
                  this.currentTask.schedule = '';
              }
          }
      },
      mounted() {
          this.loadTasks();
      }
  });
</script>
</html>